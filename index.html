<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airdrop Referral</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ğŸ Airdrop Balance</h2>
  <p id="balance">Loading...</p>

  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyD4UbW_Iy4kUWH3V70Q1mWCI4-_KFk6ku4",
      authDomain: "onlinewark-a0147.firebaseapp.com",
      databaseURL: "https://onlinewark-a0147-default-rtdb.firebaseio.com",
      projectId: "onlinewark-a0147",
      storageBucket: "onlinewark-a0147.appspot.com",
      messagingSenderId: "92155538620",
      appId: "1:92155538620:android:5e198a8eea6bf17f61f4b9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Telegram User ---
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe.user;
    const userId = user.id.toString();

    // --- Referral Parameter ---
    const refParam = tg.initDataUnsafe.start_param;
    let referrerId = null;
    if (refParam && refParam.startsWith("ref_")) {
      referrerId = refParam.split("_")[1];
    }

    // --- Init User ---
    async function initUser() {
      const userRef = db.ref("users/" + userId);

      userRef.once("value", async (snapshot) => {
        if (!snapshot.exists()) {
          // Ù†ÙˆÛŒ ÛŒÙˆØ²Ø± - Ø¬ÙˆÚ“ÙˆÙ„
          await userRef.set({
            points: 0,
            referrals: {}
          });

          // Ú©Ù‡ Ø¯ Ø±ÛŒÙ Ù„ÛŒÙ†Ú© Ù„Ù‡ Ù„Ø§Ø±Û Ø±Ø§ØºÙ„ÛŒ ÙˆÙŠ
          if (referrerId && referrerId !== userId) {
            const refRef = db.ref("users/" + referrerId + "/points");
            refRef.transaction((current) => {
              return (current || 0) + 2; // ğŸ Û² Ú©ÙˆÛŒÙ† ÙˆØ±Ú©ÙˆÙ„
            });

            // Ø±ÛŒÙØ±ÛŒÙ„ Ù„Ø³Øª Ú©Û Ù†ÙˆÛŒ ÛŒÙˆØ²Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©ÙˆÙ„
            const refList = db.ref("users/" + referrerId + "/referrals");
            refList.update({ [userId]: true });
          }
        }
        loadBalance();
      });
    }

    // --- Load Balance ---
    function loadBalance() {
      const userRef = db.ref("users/" + userId + "/points");
      userRef.on("value", (snapshot) => {
        document.getElementById("balance").innerText =
          `ğŸ’° Your Balance: ${snapshot.val() || 0} Coins`;
      });
    }

    initUser();
  </script>
</body>
</html> 
